<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/*
 * This file is extend Javascript interface of SmartAuto platform.
 * 
 * 	Reference C++ inteface : http://nutshell.suntec.net/nutshelldevelop/?p=framework/api/QtSystemAPI.git;a=tree;f=include/nqmedia;h=35f31c786a17414aea1a7cda311a9dd947280545;hb=HEAD
 *  	NQUsbManagerApi.h
 *  	NQUsbBrowserApi.h
 *  	NQUsbPlayerApi.h
 */

(function() {

       	
<span id='CONNECT_STATE'>		/**
</span>		 * enum CONNECT_STATE 
		 *
		 */
		CONNECT_STATE = {
<span id='CONNECT_STATE-property-CONNECT_STATE_OFFLINE'>			/** Offline */
</span>			CONNECT_STATE_OFFLINE : 0,
<span id='CONNECT_STATE-property-CONNECT_STATE_ONLINE_NODEVICE'>			/** Online but no device injected ： 4/25目前未使用。 */
</span>            CONNECT_STATE_ONLINE_NODEVICE : 1,
<span id='CONNECT_STATE-property-CONNECT_STATE_ONLINE_AVALIABLE'>            /** Online and some device avalible. */
</span>            CONNECT_STATE_ONLINE_AVALIABLE : 2,
<span id='CONNECT_STATE-property-CONNECT_STATE_MAX'>            CONNECT_STATE_MAX : 3
</span>		};
        	
<span id='DEVICE_TYPE'>		/**
</span>		 * enum DEVICE_TYPE 
		 *
		 */
        DEVICE_TYPE = {
<span id='DEVICE_TYPE-property-DEVICETYPE_USB1'>        	/** USB storage device No. 目前WeiChuang只支持USB1， 后面SmartAuto会有DEVICETYPE_USB2 */
</span>            DEVICETYPE_USB1 : 0, 	
<span id='DEVICE_TYPE-property-DEVICETYPE_SDCARD1'>            /**  SDCARD storage device No.1. 目前不支持 */
</span>            DEVICETYPE_SDCARD1 : 1,  	
<span id='DEVICE_TYPE-property-DEVICETYPE_USBROM1'>            /** USBROM storage device No.1.目前不支持 */
</span><span id='DEVICE_TYPE-property-DEVICETYPE_MAX'>            DEVICETYPE_USBROM1 : 2,  ///&lt; 
</span>            DEVICETYPE_MAX : 3,
            
<span id='DEVICE_TYPE-method-inRange'>            /**
</span>             * Check if the index is valid device type.
             */
            inRange : function(index){
            	if( index == DEVICE_TYPE.DEVICETYPE_USB1 ||
            		index == DEVICE_TYPE.DEVICETYPE_SDCARD1 || 
            		index == DEVICE_TYPE.DEVICETYPE_USBROM1 ){
            			return true;
            	}
            	else{
            		return false;//outof range of DEVICE_TYPE
            	}
            }
        };


       	
})();


// @tag nutshell,extJs
// @define nutshell.usbManager
// @require nutshell

<span id='nutshell-usbManager'>/**
</span> * @class nutshell.usbManager
 * @singleton
 *	
 * Entry interface of Usb service.
 * 
 */
(function() {
	
<span id='UsbDevice'>	    /**
</span>		* @class UsbDevice Device info class.
		*   为了将来支持多Usb设备，给出的UsbDeviceList的Item类型。
		*	type : The device type.
		*	path : The device path. eg. &quot;\mnt\udisk1&quot;
		*
		*  @param {DEVICE_TYPE} type The device type.
		*  @param {String} path The device path.
		*/
	    function UsbDevice(type, path){
       		this.usbDeviceType = type;
       		this.usbDevicePath = path;
       	};
       	
<span id='nutshell-usbManager'>/**
</span> * @class nutshell.usbManager
 * @singleton
 *	
 * Usb设备管理接口。
 * 	1. 
 * 
 */
 nutshell.usbManager = {
		//callbackbase 
		m_cbMgr : {},	
		
<span id='nutshell-usbManager-property-m_deviceList'>		/**
</span>		 * Useb device list which type is class UsbDevice
		 */
		m_deviceList : [],
<span id='nutshell-usbManager-property-m_selectedDeviceIndex'>		/**
</span>		 * 
		 */
		m_selectedDeviceIndex : 0, //TODO: default value is ?
				
<span id='nutshell-usbManager-property-m_connectState'>		/**
</span>		 * Connecttion state, CONNECT_STATE_OFFLINE is the default.
		 */
		m_connectState : CONNECT_STATE.CONNECT_STATE_OFFLINE,
	
	       
<span id='nutshell-usbManager-method-registerCallback'>	    /**
</span>	    * Register callback function of usb manager.
	    *		
	    * @param {String} setName Descripte the callback type.
	    * @param {Function} func Callback function.
	    */
	    registerCallback: function(setName, func){
	    	
	    	nutshell.usbManager.m_cbMgr.registerMyself(&quot;nutshell.usbManager&quot;);
	    	
	    	nutshell.usbManager.m_cbMgr.setCustomCallback(setName, func);
	    	
	    },
	    
<span id='nutshell-usbManager-method-emitCallback'>	    /**
</span>	    * Emit the callbacks from handler layer.(Usb service)
	    * 
	    * @param {String} setName Descripte the callback type.
	    * @param {Array} arguments array.
	    * 
	    */
	    emitCallback : function(setName, args){
	    	nutshell.usbManager.m_cbMgr.handle(setName, args);
	    },
	    
          
        	    
<span id='nutshell-usbManager-method-reqConnect'>		/**
</span>		 * Request to connect to server.
		 * 
		 * 1. 如果没有Usb设备的话，不会返回connectStateChangedCb。（4/26）
		 * 2. WebService进程会常驻，如果再次发出Connect请求的话，还是会正常返回cb。
		 * 
		 * @param void 
		 * @return errorCode : 0 - need to wait the signal connectStateChangedCb(CONNECT_STATE_ONLINE_AVALIABLE)
		 */
		reqConnect : function() {
			
			nutshell.usbManager.m_cbMgr.registerMyself();
			
	     	SendRequestInPage2(&quot;nutshell.usbManager.reqConnect&quot;);		
		},

<span id='nutshell-usbManager-method-reqDisconnect'>		/**
</span>		 * Request to disconnect to server.
		 * 
		 * 多次调用该接口时，是否都有cb？（Yes）
		 * 
		 * @param void
		 * @return errorCode : 0 - need to wait the signal connectStateChangedCb(CONNECT_STATE_OFFLINE)
		 */
		reqDisconnect : function() {
			SendRequestInPage2(&quot;nutshell.usbManager.reqDisconnect&quot;);	
		},

<span id='nutshell-usbManager-method-reqChangeDevice'>        /**
</span>         * Request to change to a selected storage device.
         * 
         * 	目前不需要。 也是为了将来支持多设备。
         *
         * @param index : [IN] selected storage device index (defined in enum DEVICETYPE)
         * @return errorCode
         */
       reqChangeDevice : function(index) {
			var param = {
				&quot;index&quot;:index
			};
       		SendRequestInPage2(&quot;nutshell.usbManager.reqChangeDevice&quot;, JSON.stringify(param));
  		},
  		
<span id='nutshell-usbManager-method-getConnectState'>  		/**
</span>  		 * Retrieve the connect state. 
  		 * 
  		 * @return CONNECT_STATE @link{CONNECT_STATE}
  		 */
  		getConnectState : function() {
  			return nutshell.usbManager.m_connectState;
  		},
  		
<span id='nutshell-usbManager-method-isConnected'>  		/**
</span>  		 * Whether connected?
  		 * 
  		 * 如果没有Usb设备的话，不会返回connectStateChangedCb
  		 * 
  		 * @return true : if connected.
  		 */
  		isConnected : function(){
  			return (nutshell.usbManager.m_connectState == CONNECT_STATE.CONNECT_STATE_ONLINE_AVALIABLE || 
  					nutshell.usbManager.m_connectState == CONNECT_STATE.CONNECT_STATE_ONLINE_NODEVICE );
  		},
  		
<span id='nutshell-usbManager-method-isConnectedDevice'>    	/**
</span>  		 * Whether connected to any device?
  		 * 
  		 * @return true : if connected to any usb device.
  		 */		
  		 isConnectedDevice : function(){
  			return (nutshell.usbManager.m_connectState == CONNECT_STATE.CONNECT_STATE_ONLINE_AVALIABLE );
  		},
        
		
<span id='nutshell-usbManager-method-createBrowser'>  		/**
</span>         * Get Browser API.
         * 
         *	目前底层 是单例方式。
         * 
         * @return errorcode : NULL - Error happened.
         */
         createBrowser : function(){
         	if( nutshell.usbManager.isConnected() ) { //TODO: or isConnectedDevice?
         		return nutshell.usbBrowser;
         	}
        	else {
        		return null;
        	}
        },

<span id='nutshell-usbManager-method-createPlayer'>        /**
</span>         * Get Player API.
         *
         * @return errorcode : NULL - Error happened.
         */
        createPlayer : function(){
         	if( nutshell.usbManager.isConnectedDevice() ) { 
         		return nutshell.usbPlayer;
         	}
        	else {
        		return null;
        	}
        },
        
        
<span id='nutshell-usbManager-method-getDeviceList'>        /**
</span>         * Get the item list in DeviceList.
         * @note Index start from 1, not 0!
         * @note Update the value when emit the signal deviceListUpdatedCb().
         * 
         * [C++] virtual qint32 getDeviceList(QList&lt;DEVICELIST_ITEM&gt;&amp; strList) = 0;
         * 
         * 1. 可能需要异步方式？
         * 2. 返回的List是什么类型？
         * 
         * @param strList : [OUT] the item list
         * @return devicelist : @link{UsbDevice}
         * 						null -- if no device valid.
         */
        getDeviceList : function() {
        	if( nutshell.usbManager.isConnectedDevice() ){
        	    return nutshell.usbManager.m_deviceList;
        	}
        	else{
        		return null;
        	}
        },

<span id='nutshell-usbManager-method-getDeviceIndex'>        /**
</span>         * Get the index of selected storage device.
         * @note Update the value when emit the signal changeDeviceUpdatedCb().
         * 
         * [C++]virtual qint32 getDeviceIndex(qint32&amp; index) = 0;
         *
         * @param index : [IN] selected storage device index (defined in enum DEVICETYPE)
         * @return errorCode
         */
        getDeviceIndex : function() {
        	return nutshell.usbManager.m_selectedDeviceIndex;
        },
        
        
        ///////////////// Signal ////////////////////////////////
<span id='nutshell-usbManager-property-'>        /**
</span>         *	未Connect状态
         * 1. Actioin： reqConnect请求。
         *  	cb： connectStateChangedCb（Offline）
         * 		？？ 没有 deviceListUpdatedCb
         *
         *	 
         *	已经Connect后。
         * 1. Action: 拨Usb设备
         * 		cb： connectStateChangedCb（Offline）&amp;&amp; deviceListUpdatedCb（有没有？）
         * 2. Action： 插件Usb设备 
         * 		cb ：  connectStateChangedCb（Available）&amp;&amp; deviceListUpdatedCb（List（只有一个））
         */
        
        
<span id='nutshell-usbManager-event-connectStateChangedCb'>		 /**
</span>         * @event connectStateChangedCb
         * Notify UI if connect state changed.
         *
         *	响应低层来的connectStateChanged通知，
         *	
         *
         * @param state : [IN] latest connect state.// @link reqConnect &amp;&amp; reqDisconnect.
         * @param errorCode : [IN] error code. // 目前未使用。
         * @return {boolean} if changed : true - the connect state has changed and Notify UI. false - No state change and Don't notify ui.
         * 						 
         */
        connectStateChangedCb : function(state, errorCode){
        	if( state == &quot;undefined&quot; || errorCode == &quot;undefined&quot; ){
        		//invalid  input.
        		return false;
        	}
        	
			if( errorCode == 0 ){//success
				if( nutshell.usbManager.m_connectState != state ){
					nutshell.usbManager.m_connectState = state;
					return true;
				}
				else{
					return false;
				}
			}
			else{
				//TODO: Has the state still changed if failed?
				if( nutshell.usbManager.m_connectState != state ){
					nutshell.usbManager.m_connectState = state;
					return true;
				}
				else{
					return false;
				}
			}
		},
			
<span id='global-event-deviceListUpdatedCb'>        /**
</span>         * Notify UI if storage deviceList successfully changed.
         * @event deviceListUpdatedCb
         * [C++] NQUsbManagerImp::deviceListUpdatedCb(const QVector&lt;NMUSB_DEVICE_INFO&gt;&amp; strList)
         * 
         * @ignore  
         * 	拔掉Usb设备时，有deviceListUpdatedCb么？
         *
         * @param void
         * @return void
         * @note UI can call getDeviceList() after UI recieved this signal.
         */
        deviceListUpdatedCb : function(deviceInfoList){
        	// clear
        	nutshell.usbManager.m_deviceList = [];
        	
        	var i;
        	for( i in deviceInfoList ){
        		nutshell.usbManager.m_deviceList.push(new UsbDevice(deviceInfoList[i].deviceType, deviceInfoList[i].devicePath) );
        	}
        	//foreach (dummy code)
        	//nutshell.usbManager.m_deviceList.push(new UsbDevice(DEVICE_TYPE.DEVICETYPE_USB1, &quot;DEVICETYPE_USB1Path&quot;) );
        	//nutshell.usbManager.m_deviceList.push(new UsbDevice(DEVICE_TYPE.DEVICETYPE_SDCARD1, &quot;DEVICETYPE_SDCARD1Path&quot;) );
        	//nutshell.usbManager.m_deviceList.push(new UsbDevice(DEVICE_TYPE.DEVICETYPE_USBROM1, &quot;DEVICETYPE_USBROM1Path&quot;) );
        	 
        	console.log(nutshell.usbManager.m_deviceList);
        	//TODO: notify to the UI caller.
        	
        	return true;
        },
        
<span id='global-event-changeDeviceUpdatedCb'>        /**
</span>         * Notify UI if change to a selected storage device.
         * 
         * @event 
         * [C++] NQUsbManagerImp::changeDeviceUpdatedCb(qint32 index)
         *
         * @ignore  ：将来多设备使用。
         * @param index : [IN] selected device index.
         * @return boolean : true - value changed.
         * 					 false - value not changed.
         */
        changeDeviceUpdatedCb : function( index){
        	
        	if( !DEVICE_TYPE.inRange(index) ){
        		return false;
        	}        	
        	
        	if( nutshell.usbManager.m_selectedDeviceIndex != index ){
        		nutshell.usbManager.m_selectedDeviceIndex = index;
        		return true;
        	}
        	else{
        		return false;
        	}
        }
        
        
	};
	
<span id='nutshell-usbManager-property-m_cbMgr'>		/**
</span>	 * 
	 */
	nutshell.usbManager.m_cbMgr = callbackBase.createInstance();
	
	nutshell.usbManager.m_cbMgr.setApi(nutshell.usbManager);

})();
</pre>
</body>
</html>
